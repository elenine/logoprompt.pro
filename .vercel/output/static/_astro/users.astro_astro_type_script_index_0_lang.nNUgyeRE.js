let s=1,m="all",f;async function u(t=1,o="all",n=""){const e=document.getElementById("users-tbody");e.textContent="";const a=document.createElement("tr"),l=document.createElement("td");l.colSpan=5,l.className="loading-state",l.textContent="Loading users...",a.appendChild(l),e.appendChild(a);try{const i=new URLSearchParams({page:t.toString(),limit:"20",filter:o});n&&i.set("search",n);const r=await fetch(`/api/admin/users?${i}`);if(!r.ok)throw new Error("Failed to load users");const c=await r.json();b(c.users),B(c.pagination)}catch(i){console.error("Load users error:",i),e.textContent="";const r=document.createElement("tr"),c=document.createElement("td");c.colSpan=5,c.className="error-state",c.textContent="Failed to load users",r.appendChild(c),e.appendChild(r)}}function b(t){const o=document.getElementById("users-tbody");if(o.textContent="",t.length===0){const n=document.createElement("tr"),e=document.createElement("td");e.colSpan=5,e.className="empty-state",e.textContent="No users found",n.appendChild(e),o.appendChild(n);return}t.forEach(n=>{const e=document.createElement("tr"),a=document.createElement("td"),l=document.createElement("div");l.className="user-info";const i=document.createElement("strong");i.textContent=n.name;const r=document.createElement("span");r.textContent=n.email,l.appendChild(i),l.appendChild(r),a.appendChild(l),e.appendChild(a);const c=document.createElement("td");if(n.isAdmin){const d=document.createElement("span");d.className="badge badge-admin",d.textContent="Admin",c.appendChild(d)}if(!n.isAdmin){const d=document.createElement("span");d.className="badge badge-user",d.textContent="User",c.appendChild(d)}e.appendChild(c);const C=document.createElement("td");if(n.subscriptionStatus==="active"){const d=document.createElement("span");d.className="badge badge-subscribed",d.textContent="Pro",C.appendChild(d)}else{const d=document.createElement("span");d.className="badge badge-free",d.textContent="Free",C.appendChild(d)}e.appendChild(C);const h=document.createElement("td");h.textContent=new Date(n.createdAt).toLocaleDateString(),e.appendChild(h);const y=document.createElement("td"),E=document.createElement("button");E.className="action-btn",E.textContent="Edit",E.addEventListener("click",()=>x(n)),y.appendChild(E),e.appendChild(y),o.appendChild(e)})}function B(t){const o=document.getElementById("pagination");if(o.textContent="",t.totalPages<=1)return;const n=document.createElement("button");n.textContent="Previous",n.disabled=t.page===1,n.addEventListener("click",()=>{s=t.page-1,u(s,m,p())}),o.appendChild(n);const e=document.createElement("span");e.textContent=`Page ${t.page} of ${t.totalPages}`,o.appendChild(e);const a=document.createElement("button");a.textContent="Next",a.disabled=t.page===t.totalPages,a.addEventListener("click",()=>{s=t.page+1,u(s,m,p())}),o.appendChild(a)}function p(){return document.getElementById("search-input").value}function x(t){document.getElementById("edit-user-id").value=t.id,document.getElementById("edit-name").value=t.name,document.getElementById("edit-email").value=t.email,document.getElementById("edit-is-admin").checked=t.isAdmin,document.getElementById("edit-modal").style.display="flex"}function g(){document.getElementById("edit-modal").style.display="none"}document.getElementById("search-input")?.addEventListener("input",()=>{clearTimeout(f),f=setTimeout(()=>{s=1,u(s,m,p())},300)});document.getElementById("filter-select")?.addEventListener("change",t=>{m=t.target.value,s=1,u(s,m,p())});document.getElementById("cancel-edit")?.addEventListener("click",g);document.querySelector(".modal-backdrop")?.addEventListener("click",g);document.getElementById("edit-form")?.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("edit-user-id").value,n=document.getElementById("edit-is-admin").checked;try{const e=await fetch(`/api/admin/users/${o}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({isAdmin:n})});if(!e.ok){const a=await e.json();throw new Error(a.error||"Failed to update user")}g(),u(s,m,p())}catch(e){const a=e instanceof Error?e.message:"Failed to update user";alert(a)}});u();
