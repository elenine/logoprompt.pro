---
import Layout from '../layouts/Layout.astro';

export const prerender = false;

// Redirect if already logged in
const session = Astro.locals.session;
if (session) {
  const redirect = Astro.url.searchParams.get('redirect') || '/profile';
  return Astro.redirect(redirect);
}

const error = Astro.url.searchParams.get('error');
---

<Layout title="Login - LogoPrompt.pro" description="Sign in to your LogoPrompt.pro account">
  <main class="auth-page">
    <div class="auth-container">
      <div class="auth-card">
        <h1>Welcome Back</h1>
        <p class="subtitle">Sign in to access your profile</p>

        {error && (
          <div class="error-message">
            {error === 'auth_failed' ? 'Authentication failed. Please try again.' : error}
          </div>
        )}

        <button id="google-signin" class="google-btn" type="button">
          <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          <span class="spinner" style="display: none;"></span>
          <span class="btn-text">Continue with Google</span>
        </button>

        <div class="divider">
          <span>or</span>
        </div>

        <form id="login-form" class="auth-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required autocomplete="email" placeholder="you@example.com" />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required autocomplete="current-password" placeholder="Enter your password" />
          </div>

          <button type="submit" class="submit-btn">
            <span class="btn-text">Sign In</span>
            <span class="btn-loading" style="display: none;">Signing in...</span>
          </button>

          <div id="form-error" class="form-error" style="display: none;"></div>
        </form>

        <div class="auth-links">
          <a href="/forgot-password">Forgot password?</a>
        </div>

        <p class="auth-switch">
          Don't have an account? <a href="/signup">Sign up</a>
        </p>

        <p class="terms-notice">
          By signing in, you agree to our
          <a href="/terms">Terms of Service</a> and
          <a href="/privacy">Privacy Policy</a>
        </p>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { authClient } from '../lib/auth-client';

  // Google sign in
  document.getElementById('google-signin')?.addEventListener('click', async () => {
    const button = document.getElementById('google-signin') as HTMLButtonElement;
    const icon = button.querySelector('.google-icon') as HTMLElement;
    const spinner = button.querySelector('.spinner') as HTMLElement;
    const btnText = button.querySelector('.btn-text') as HTMLElement;

    button.disabled = true;
    icon.style.display = 'none';
    spinner.style.display = 'block';
    btnText.textContent = 'Signing in...';

    try {
      const urlParams = new URLSearchParams(window.location.search);
      const redirectUrl = urlParams.get('redirect') || '/profile';

      await authClient.signIn.social({
        provider: 'google',
        callbackURL: redirectUrl,
        errorCallbackURL: '/login?error=auth_failed',
      });
    } catch (error) {
      console.error('Google sign in error:', error);
      button.disabled = false;
      icon.style.display = 'block';
      spinner.style.display = 'none';
      btnText.textContent = 'Continue with Google';
    }
  });

  // Email/password sign in
  document.getElementById('login-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target as HTMLFormElement;
    const submitBtn = form.querySelector('.submit-btn') as HTMLButtonElement;
    const btnText = form.querySelector('.btn-text') as HTMLElement;
    const btnLoading = form.querySelector('.btn-loading') as HTMLElement;
    const errorDiv = document.getElementById('form-error') as HTMLElement;

    const email = (form.querySelector('#email') as HTMLInputElement).value;
    const password = (form.querySelector('#password') as HTMLInputElement).value;

    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    errorDiv.style.display = 'none';

    try {
      const result = await authClient.signIn.email({
        email,
        password,
      });

      if (result.error) {
        throw new Error(result.error.message || 'Sign in failed');
      }

      const urlParams = new URLSearchParams(window.location.search);
      const redirectUrl = urlParams.get('redirect') || '/profile';
      window.location.href = redirectUrl;
    } catch (error: any) {
      errorDiv.textContent = error.message || 'Sign in failed. Please try again.';
      errorDiv.style.display = 'block';
      submitBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
    }
  });
</script>

<style>
  .auth-page {
    min-height: calc(100vh - 200px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
  }

  .auth-container {
    width: 100%;
    max-width: 420px;
  }

  .auth-card {
    background: rgb(var(--bg-primary));
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-lg);
    padding: 2.5rem;
    box-shadow: var(--shadow-lg);
  }

  h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    color: rgb(var(--text-primary));
    text-align: center;
  }

  .subtitle {
    color: rgb(var(--text-secondary));
    margin: 0 0 1.5rem 0;
    font-size: 0.95rem;
    text-align: center;
  }

  .error-message {
    background: rgba(220, 38, 38, 0.1);
    color: rgb(var(--accent));
    padding: 0.75rem 1rem;
    border-radius: var(--radius-sm);
    margin-bottom: 1rem;
    font-size: 0.875rem;
    text-align: center;
  }

  .google-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.875rem 1.5rem;
    background: rgb(var(--bg-primary));
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 500;
    color: rgb(var(--text-primary));
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .google-btn:hover:not(:disabled) {
    background: rgb(var(--bg-secondary));
    border-color: rgb(var(--card-hover-border));
    box-shadow: var(--shadow-md);
  }

  .google-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgb(var(--card-border));
    border-top-color: rgb(var(--accent));
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .divider {
    display: flex;
    align-items: center;
    margin: 1.5rem 0;
    gap: 1rem;
  }

  .divider::before,
  .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgb(var(--card-border));
  }

  .divider span {
    color: rgb(var(--text-tertiary));
    font-size: 0.875rem;
  }

  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-size: 0.875rem;
    font-weight: 500;
    color: rgb(var(--text-primary));
  }

  .form-group input {
    padding: 0.75rem 1rem;
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-sm);
    font-size: 1rem;
    color: rgb(var(--text-primary));
    background: rgb(var(--bg-primary));
    transition: border-color var(--transition-fast);
  }

  .form-group input:focus {
    outline: none;
    border-color: rgb(var(--accent));
  }

  .form-group input::placeholder {
    color: rgb(var(--text-muted));
  }

  .submit-btn {
    width: 100%;
    padding: 0.875rem;
    background: rgb(var(--accent));
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background var(--transition-fast);
    margin-top: 0.5rem;
  }

  .submit-btn:hover:not(:disabled) {
    background: rgb(var(--accent-hover));
  }

  .submit-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .form-error {
    background: rgba(220, 38, 38, 0.1);
    color: rgb(var(--accent));
    padding: 0.75rem 1rem;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    text-align: center;
  }

  .auth-links {
    text-align: right;
    margin-top: 0.5rem;
  }

  .auth-links a {
    color: rgb(var(--accent));
    font-size: 0.875rem;
    text-decoration: none;
  }

  .auth-links a:hover {
    text-decoration: underline;
  }

  .auth-switch {
    text-align: center;
    margin-top: 1.5rem;
    color: rgb(var(--text-secondary));
    font-size: 0.95rem;
  }

  .auth-switch a {
    color: rgb(var(--accent));
    text-decoration: none;
    font-weight: 500;
  }

  .auth-switch a:hover {
    text-decoration: underline;
  }

  .terms-notice {
    margin-top: 1.5rem;
    font-size: 0.8rem;
    color: rgb(var(--text-tertiary));
    text-align: center;
  }

  .terms-notice a {
    color: rgb(var(--accent));
    text-decoration: none;
  }

  .terms-notice a:hover {
    text-decoration: underline;
  }
</style>
