---
import Layout from '../../layouts/Layout.astro';

export const prerender = false;

if (!Astro.locals.isAdmin) {
  return Astro.redirect('/');
}
---

<Layout title="Referral Links - Admin" description="Manage referral links">
  <main class="admin-page">
    <div class="admin-container">
      <header class="page-header">
        <div class="header-left">
          <a href="/admin" class="back-btn">&larr; Back</a>
          <h1>Referral Links</h1>
        </div>
        <button id="add-link-btn" class="add-btn">+ Add Link</button>
      </header>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Referral Code</th>
              <th>Direct Ad URL</th>
              <th>Affiliate</th>
              <th>Status</th>
              <th>Verified</th>
              <th>Clicks</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="links-tbody">
            <tr>
              <td colspan="7" class="loading-state">Loading links...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Add/Edit Link Modal -->
  <div id="link-modal" class="modal" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <h2 id="modal-title">Add Referral Link</h2>
      <form id="link-form">
        <input type="hidden" id="link-id" />

        <div class="form-group">
          <label for="link-code">Referral Code</label>
          <input type="text" id="link-code" placeholder="e.g., partner1" required />
          <small>Used in URL: ?ref=partner1</small>
        </div>

        <div class="form-group">
          <label for="link-url">Direct Ad URL</label>
          <input type="url" id="link-url" placeholder="https://adnetwork.com/..." required />
        </div>

        <div class="form-group">
          <label for="link-description">Description (Optional)</label>
          <input type="text" id="link-description" placeholder="Partner name or notes" />
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" id="link-active" checked />
            <span>Active</span>
          </label>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="cancel-link">Cancel</button>
          <button type="submit" class="btn-primary">Save Link</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <h2>Delete Referral Link</h2>
      <p>Are you sure you want to delete this referral link? This action cannot be undone.</p>
      <input type="hidden" id="delete-link-id" />
      <div class="modal-actions">
        <button type="button" class="btn-secondary" id="cancel-delete">Cancel</button>
        <button type="button" class="btn-danger" id="confirm-delete">Delete</button>
      </div>
    </div>
  </div>
</Layout>

<script>
  interface ReferralLink {
    id: string;
    referralCode: string;
    directAdUrl: string;
    affiliateId: string | null;
    affiliateName: string | null;
    affiliateEmail: string | null;
    isActive: boolean;
    isVerified: boolean;
    description: string | null;
    clickCount: string;
    createdAt: string;
  }

  async function loadLinks() {
    const tbody = document.getElementById('links-tbody')!;
    tbody.textContent = '';
    const loadingRow = document.createElement('tr');
    const loadingCell = document.createElement('td');
    loadingCell.colSpan = 7;
    loadingCell.className = 'loading-state';
    loadingCell.textContent = 'Loading links...';
    loadingRow.appendChild(loadingCell);
    tbody.appendChild(loadingRow);

    try {
      const response = await fetch('/api/admin/referral-links');
      if (!response.ok) throw new Error('Failed to load links');

      const data = await response.json();
      renderLinks(data.links);
    } catch (error) {
      console.error('Load links error:', error);
      tbody.textContent = '';
      const errorRow = document.createElement('tr');
      const errorCell = document.createElement('td');
      errorCell.colSpan = 7;
      errorCell.className = 'error-state';
      errorCell.textContent = 'Failed to load links';
      errorRow.appendChild(errorCell);
      tbody.appendChild(errorRow);
    }
  }

  function renderLinks(links: ReferralLink[]) {
    const tbody = document.getElementById('links-tbody')!;
    tbody.textContent = '';

    if (links.length === 0) {
      const emptyRow = document.createElement('tr');
      const emptyCell = document.createElement('td');
      emptyCell.colSpan = 7;
      emptyCell.className = 'empty-state';
      emptyCell.textContent = 'No referral links yet. Add one to get started.';
      emptyRow.appendChild(emptyCell);
      tbody.appendChild(emptyRow);
      return;
    }

    links.forEach(link => {
      const tr = document.createElement('tr');

      // Referral Code
      const codeCell = document.createElement('td');
      const codeWrapper = document.createElement('div');
      codeWrapper.className = 'code-wrapper';
      const codeBadge = document.createElement('code');
      codeBadge.textContent = link.referralCode;
      codeWrapper.appendChild(codeBadge);
      if (link.description) {
        const desc = document.createElement('small');
        desc.textContent = link.description;
        codeWrapper.appendChild(desc);
      }
      codeCell.appendChild(codeWrapper);
      tr.appendChild(codeCell);

      // URL
      const urlCell = document.createElement('td');
      urlCell.className = 'url-cell';
      const urlText = document.createElement('span');
      urlText.className = 'truncate';
      urlText.textContent = link.directAdUrl;
      urlText.title = link.directAdUrl;
      urlCell.appendChild(urlText);
      tr.appendChild(urlCell);

      // Affiliate
      const affiliateCell = document.createElement('td');
      if (link.affiliateName) {
        const affiliateInfo = document.createElement('div');
        affiliateInfo.className = 'user-info';
        const name = document.createElement('strong');
        name.textContent = link.affiliateName;
        affiliateInfo.appendChild(name);
        if (link.affiliateEmail) {
          const email = document.createElement('span');
          email.textContent = link.affiliateEmail;
          affiliateInfo.appendChild(email);
        }
        affiliateCell.appendChild(affiliateInfo);
      } else {
        affiliateCell.textContent = '-';
      }
      tr.appendChild(affiliateCell);

      // Status
      const statusCell = document.createElement('td');
      const statusBadge = document.createElement('span');
      statusBadge.className = `status-badge ${link.isActive ? 'active' : 'inactive'}`;
      statusBadge.textContent = link.isActive ? 'Active' : 'Inactive';
      statusCell.appendChild(statusBadge);
      tr.appendChild(statusCell);

      // Verified
      const verifiedCell = document.createElement('td');
      const verifiedBadge = document.createElement('span');
      verifiedBadge.className = `status-badge ${link.isVerified ? 'verified' : 'unverified'}`;
      verifiedBadge.textContent = link.isVerified ? 'Verified' : 'Pending';
      verifiedCell.appendChild(verifiedBadge);
      tr.appendChild(verifiedCell);

      // Clicks
      const clicksCell = document.createElement('td');
      clicksCell.textContent = link.clickCount || '0';
      tr.appendChild(clicksCell);

      // Actions
      const actionsCell = document.createElement('td');
      actionsCell.className = 'actions-cell';

      // Verify/Unverify button
      const verifyBtn = document.createElement('button');
      verifyBtn.className = `action-btn ${link.isVerified ? 'warning' : 'success'}`;
      verifyBtn.textContent = link.isVerified ? 'Unverify' : 'Verify';
      verifyBtn.addEventListener('click', () => toggleVerification(link.id, !link.isVerified));
      actionsCell.appendChild(verifyBtn);

      const editBtn = document.createElement('button');
      editBtn.className = 'action-btn';
      editBtn.textContent = 'Edit';
      editBtn.addEventListener('click', () => openEditModal(link));
      actionsCell.appendChild(editBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'action-btn danger';
      deleteBtn.textContent = 'Delete';
      deleteBtn.addEventListener('click', () => openDeleteModal(link.id));
      actionsCell.appendChild(deleteBtn);

      tr.appendChild(actionsCell);

      tbody.appendChild(tr);
    });
  }

  function openAddModal() {
    (document.getElementById('modal-title') as HTMLElement).textContent = 'Add Referral Link';
    (document.getElementById('link-id') as HTMLInputElement).value = '';
    (document.getElementById('link-code') as HTMLInputElement).value = '';
    (document.getElementById('link-code') as HTMLInputElement).readOnly = false;
    (document.getElementById('link-url') as HTMLInputElement).value = '';
    (document.getElementById('link-description') as HTMLInputElement).value = '';
    (document.getElementById('link-active') as HTMLInputElement).checked = true;
    document.getElementById('link-modal')!.style.display = 'flex';
  }

  function openEditModal(link: ReferralLink) {
    (document.getElementById('modal-title') as HTMLElement).textContent = 'Edit Referral Link';
    (document.getElementById('link-id') as HTMLInputElement).value = link.id;
    (document.getElementById('link-code') as HTMLInputElement).value = link.referralCode;
    (document.getElementById('link-code') as HTMLInputElement).readOnly = true;
    (document.getElementById('link-url') as HTMLInputElement).value = link.directAdUrl;
    (document.getElementById('link-description') as HTMLInputElement).value = link.description || '';
    (document.getElementById('link-active') as HTMLInputElement).checked = link.isActive;
    document.getElementById('link-modal')!.style.display = 'flex';
  }

  function closeLinkModal() {
    document.getElementById('link-modal')!.style.display = 'none';
  }

  function openDeleteModal(linkId: string) {
    (document.getElementById('delete-link-id') as HTMLInputElement).value = linkId;
    document.getElementById('delete-modal')!.style.display = 'flex';
  }

  function closeDeleteModal() {
    document.getElementById('delete-modal')!.style.display = 'none';
  }

  async function toggleVerification(linkId: string, isVerified: boolean) {
    try {
      const response = await fetch(`/api/admin/referral-links/${linkId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ isVerified }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to update verification status');
      }

      loadLinks();
    } catch (error: unknown) {
      const errorMessage = error instanceof Error ? error.message : 'Failed to update verification status';
      alert(errorMessage);
    }
  }

  // Event listeners
  document.getElementById('add-link-btn')?.addEventListener('click', openAddModal);
  document.getElementById('cancel-link')?.addEventListener('click', closeLinkModal);
  document.getElementById('cancel-delete')?.addEventListener('click', closeDeleteModal);

  document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
    backdrop.addEventListener('click', () => {
      closeLinkModal();
      closeDeleteModal();
    });
  });

  document.getElementById('link-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const linkId = (document.getElementById('link-id') as HTMLInputElement).value;
    const referralCode = (document.getElementById('link-code') as HTMLInputElement).value;
    const directAdUrl = (document.getElementById('link-url') as HTMLInputElement).value;
    const description = (document.getElementById('link-description') as HTMLInputElement).value;
    const isActive = (document.getElementById('link-active') as HTMLInputElement).checked;

    try {
      const isEdit = !!linkId;
      const url = isEdit ? `/api/admin/referral-links/${linkId}` : '/api/admin/referral-links';
      const method = isEdit ? 'PATCH' : 'POST';

      const body: Record<string, unknown> = {
        directAdUrl,
        description: description || null,
        isActive,
      };
      if (!isEdit) {
        body.referralCode = referralCode;
      }

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to save link');
      }

      closeLinkModal();
      loadLinks();
    } catch (error: unknown) {
      const errorMessage = error instanceof Error ? error.message : 'Failed to save link';
      alert(errorMessage);
    }
  });

  document.getElementById('confirm-delete')?.addEventListener('click', async () => {
    const linkId = (document.getElementById('delete-link-id') as HTMLInputElement).value;

    try {
      const response = await fetch(`/api/admin/referral-links/${linkId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to delete link');
      }

      closeDeleteModal();
      loadLinks();
    } catch (error: unknown) {
      const errorMessage = error instanceof Error ? error.message : 'Failed to delete link';
      alert(errorMessage);
    }
  });

  // Initial load
  loadLinks();
</script>

<style>
  .admin-page {
    min-height: calc(100vh - 200px);
    padding: 2rem 1rem;
  }

  .admin-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .back-btn {
    color: rgb(var(--text-secondary));
    text-decoration: none;
  }

  .page-header h1 {
    font-size: 1.5rem;
    margin: 0;
    color: rgb(var(--text-primary));
  }

  .add-btn {
    padding: 0.5rem 1rem;
    background: rgb(var(--accent));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 500;
    cursor: pointer;
  }

  .table-container {
    background: rgb(var(--bg-primary));
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-lg);
    overflow-x: auto;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
  }

  .data-table th,
  .data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid rgb(var(--card-border));
  }

  .data-table th {
    font-size: 0.8rem;
    font-weight: 600;
    color: rgb(var(--text-muted));
    text-transform: uppercase;
    background: rgb(var(--bg-secondary));
  }

  .code-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .code-wrapper code {
    background: rgb(var(--bg-secondary));
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    display: inline-block;
    width: fit-content;
  }

  .code-wrapper small {
    color: rgb(var(--text-muted));
    font-size: 0.8rem;
  }

  .url-cell {
    max-width: 250px;
  }

  .truncate {
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: rgb(var(--text-secondary));
    font-size: 0.85rem;
  }

  .user-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .user-info span {
    color: rgb(var(--text-muted));
    font-size: 0.8rem;
  }

  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
  }

  .status-badge.active { background: rgba(40, 167, 69, 0.1); color: #28a745; }
  .status-badge.inactive { background: rgba(108, 117, 125, 0.1); color: #6c757d; }
  .status-badge.verified { background: rgba(0, 123, 255, 0.1); color: #007bff; }
  .status-badge.unverified { background: rgba(255, 193, 7, 0.1); color: #e0a800; }

  .actions-cell {
    display: flex;
    gap: 0.5rem;
  }

  .action-btn {
    padding: 0.4rem 0.75rem;
    background: rgb(var(--accent));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    cursor: pointer;
  }

  .action-btn.danger {
    background: #dc3545;
  }

  .action-btn.success {
    background: #28a745;
  }

  .action-btn.warning {
    background: #ffc107;
    color: #212529;
  }

  .loading-state,
  .error-state,
  .empty-state {
    text-align: center;
    padding: 2rem !important;
    color: rgb(var(--text-muted));
  }

  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    position: relative;
    background: rgb(var(--bg-primary));
    border-radius: var(--radius-lg);
    padding: 2rem;
    width: 100%;
    max-width: 450px;
    margin: 1rem;
  }

  .modal-content h2 {
    margin: 0 0 1.5rem;
    color: rgb(var(--text-primary));
  }

  .modal-content p {
    color: rgb(var(--text-secondary));
    margin-bottom: 1.5rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    font-size: 0.9rem;
    font-weight: 500;
    color: rgb(var(--text-primary));
    margin-bottom: 0.5rem;
  }

  .form-group input[type="text"],
  .form-group input[type="url"] {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-sm);
    background: rgb(var(--bg-primary));
    color: rgb(var(--text-primary));
  }

  .form-group input[readonly] {
    background: rgb(var(--bg-secondary));
    color: rgb(var(--text-muted));
  }

  .form-group small {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.8rem;
    color: rgb(var(--text-muted));
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
  }

  .modal-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  .btn-secondary,
  .btn-primary,
  .btn-danger {
    flex: 1;
    padding: 0.75rem;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 500;
    cursor: pointer;
  }

  .btn-secondary {
    background: rgb(var(--bg-secondary));
    color: rgb(var(--text-primary));
    border: 1px solid rgb(var(--card-border));
  }

  .btn-primary {
    background: rgb(var(--accent));
    color: white;
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }
</style>
