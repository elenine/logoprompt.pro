---
import Layout from '../../layouts/Layout.astro';

export const prerender = false;

if (!Astro.locals.isAdmin) {
  return Astro.redirect('/');
}
---

<Layout title="User Management - Admin" description="Manage users">
  <main class="admin-page">
    <div class="admin-container">
      <header class="page-header">
        <div class="header-left">
          <a href="/admin" class="back-btn">&larr; Back</a>
          <h1>User Management</h1>
        </div>
        <div class="header-actions">
          <input type="text" id="search-input" placeholder="Search users..." class="search-input" />
          <select id="filter-select" class="filter-select">
            <option value="all">All Users</option>
            <option value="affiliates">Affiliates Only</option>
            <option value="admins">Admins Only</option>
          </select>
        </div>
      </header>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Status</th>
              <th>Referral Code</th>
              <th>Referred By</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            <tr>
              <td colspan="6" class="loading-state">Loading users...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination" id="pagination"></div>
    </div>
  </main>

  <!-- Edit User Modal -->
  <div id="edit-modal" class="modal" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <h2>Edit User</h2>
      <form id="edit-form">
        <input type="hidden" id="edit-user-id" />

        <div class="form-group">
          <label>Name</label>
          <input type="text" id="edit-name" readonly class="readonly-input" />
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="edit-email" readonly class="readonly-input" />
        </div>

        <div class="form-group">
          <label for="edit-referral-code">Referral Code</label>
          <input type="text" id="edit-referral-code" placeholder="e.g., partner1" />
          <small>Unique code for affiliate links</small>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" id="edit-is-affiliate" />
            <span>Is Affiliate</span>
          </label>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" id="edit-is-admin" />
            <span>Is Admin</span>
          </label>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="cancel-edit">Cancel</button>
          <button type="submit" class="btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<script>
  interface User {
    id: string;
    name: string;
    email: string;
    isAdmin: boolean;
    isAffiliate: boolean;
    referralCode: string | null;
    referredBy: string | null;
    subscriptionStatus: string | null;
    createdAt: string;
  }

  let currentPage = 1;
  let currentFilter = 'all';
  let searchTimeout: ReturnType<typeof setTimeout>;

  async function loadUsers(page = 1, filter = 'all', search = '') {
    const tbody = document.getElementById('users-tbody')!;
    tbody.textContent = '';
    const loadingRow = document.createElement('tr');
    const loadingCell = document.createElement('td');
    loadingCell.colSpan = 6;
    loadingCell.className = 'loading-state';
    loadingCell.textContent = 'Loading users...';
    loadingRow.appendChild(loadingCell);
    tbody.appendChild(loadingRow);

    try {
      const params = new URLSearchParams({
        page: page.toString(),
        limit: '20',
        filter,
      });
      if (search) params.set('search', search);

      const response = await fetch(`/api/admin/users?${params}`);
      if (!response.ok) throw new Error('Failed to load users');

      const data = await response.json();
      renderUsers(data.users);
      renderPagination(data.pagination);
    } catch (error) {
      console.error('Load users error:', error);
      tbody.textContent = '';
      const errorRow = document.createElement('tr');
      const errorCell = document.createElement('td');
      errorCell.colSpan = 6;
      errorCell.className = 'error-state';
      errorCell.textContent = 'Failed to load users';
      errorRow.appendChild(errorCell);
      tbody.appendChild(errorRow);
    }
  }

  function renderUsers(users: User[]) {
    const tbody = document.getElementById('users-tbody')!;
    tbody.textContent = '';

    if (users.length === 0) {
      const emptyRow = document.createElement('tr');
      const emptyCell = document.createElement('td');
      emptyCell.colSpan = 6;
      emptyCell.className = 'empty-state';
      emptyCell.textContent = 'No users found';
      emptyRow.appendChild(emptyCell);
      tbody.appendChild(emptyRow);
      return;
    }

    users.forEach(user => {
      const tr = document.createElement('tr');

      // User info
      const userCell = document.createElement('td');
      const userInfo = document.createElement('div');
      userInfo.className = 'user-info';
      const userName = document.createElement('strong');
      userName.textContent = user.name;
      const userEmail = document.createElement('span');
      userEmail.textContent = user.email;
      userInfo.appendChild(userName);
      userInfo.appendChild(userEmail);
      userCell.appendChild(userInfo);
      tr.appendChild(userCell);

      // Status badges
      const statusCell = document.createElement('td');
      if (user.isAdmin) {
        const adminBadge = document.createElement('span');
        adminBadge.className = 'badge badge-admin';
        adminBadge.textContent = 'Admin';
        statusCell.appendChild(adminBadge);
      }
      if (user.isAffiliate) {
        const affiliateBadge = document.createElement('span');
        affiliateBadge.className = 'badge badge-affiliate';
        affiliateBadge.textContent = 'Affiliate';
        statusCell.appendChild(affiliateBadge);
      }
      if (user.subscriptionStatus === 'active') {
        const subBadge = document.createElement('span');
        subBadge.className = 'badge badge-subscribed';
        subBadge.textContent = 'Pro';
        statusCell.appendChild(subBadge);
      }
      if (!user.isAdmin && !user.isAffiliate && user.subscriptionStatus !== 'active') {
        const freeBadge = document.createElement('span');
        freeBadge.className = 'badge badge-free';
        freeBadge.textContent = 'Free';
        statusCell.appendChild(freeBadge);
      }
      tr.appendChild(statusCell);

      // Referral code
      const codeCell = document.createElement('td');
      codeCell.textContent = user.referralCode || '-';
      tr.appendChild(codeCell);

      // Referred by
      const refByCell = document.createElement('td');
      refByCell.textContent = user.referredBy || '-';
      tr.appendChild(refByCell);

      // Joined date
      const dateCell = document.createElement('td');
      dateCell.textContent = new Date(user.createdAt).toLocaleDateString();
      tr.appendChild(dateCell);

      // Actions
      const actionsCell = document.createElement('td');
      const editBtn = document.createElement('button');
      editBtn.className = 'action-btn';
      editBtn.textContent = 'Edit';
      editBtn.addEventListener('click', () => openEditModal(user));
      actionsCell.appendChild(editBtn);
      tr.appendChild(actionsCell);

      tbody.appendChild(tr);
    });
  }

  function renderPagination(pagination: { page: number; totalPages: number }) {
    const container = document.getElementById('pagination')!;
    container.textContent = '';

    if (pagination.totalPages <= 1) return;

    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'Previous';
    prevBtn.disabled = pagination.page === 1;
    prevBtn.addEventListener('click', () => {
      currentPage = pagination.page - 1;
      loadUsers(currentPage, currentFilter, getSearchValue());
    });
    container.appendChild(prevBtn);

    const pageInfo = document.createElement('span');
    pageInfo.textContent = `Page ${pagination.page} of ${pagination.totalPages}`;
    container.appendChild(pageInfo);

    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'Next';
    nextBtn.disabled = pagination.page === pagination.totalPages;
    nextBtn.addEventListener('click', () => {
      currentPage = pagination.page + 1;
      loadUsers(currentPage, currentFilter, getSearchValue());
    });
    container.appendChild(nextBtn);
  }

  function getSearchValue(): string {
    return (document.getElementById('search-input') as HTMLInputElement).value;
  }

  function openEditModal(user: User) {
    (document.getElementById('edit-user-id') as HTMLInputElement).value = user.id;
    (document.getElementById('edit-name') as HTMLInputElement).value = user.name;
    (document.getElementById('edit-email') as HTMLInputElement).value = user.email;
    (document.getElementById('edit-referral-code') as HTMLInputElement).value = user.referralCode || '';
    (document.getElementById('edit-is-affiliate') as HTMLInputElement).checked = user.isAffiliate;
    (document.getElementById('edit-is-admin') as HTMLInputElement).checked = user.isAdmin;

    document.getElementById('edit-modal')!.style.display = 'flex';
  }

  function closeEditModal() {
    document.getElementById('edit-modal')!.style.display = 'none';
  }

  // Event listeners
  document.getElementById('search-input')?.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      currentPage = 1;
      loadUsers(currentPage, currentFilter, getSearchValue());
    }, 300);
  });

  document.getElementById('filter-select')?.addEventListener('change', (e) => {
    currentFilter = (e.target as HTMLSelectElement).value;
    currentPage = 1;
    loadUsers(currentPage, currentFilter, getSearchValue());
  });

  document.getElementById('cancel-edit')?.addEventListener('click', closeEditModal);
  document.querySelector('.modal-backdrop')?.addEventListener('click', closeEditModal);

  document.getElementById('edit-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const userId = (document.getElementById('edit-user-id') as HTMLInputElement).value;
    const referralCode = (document.getElementById('edit-referral-code') as HTMLInputElement).value;
    const isAffiliate = (document.getElementById('edit-is-affiliate') as HTMLInputElement).checked;
    const isAdmin = (document.getElementById('edit-is-admin') as HTMLInputElement).checked;

    try {
      const response = await fetch(`/api/admin/users/${userId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          referralCode: referralCode || null,
          isAffiliate,
          isAdmin,
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to update user');
      }

      closeEditModal();
      loadUsers(currentPage, currentFilter, getSearchValue());
    } catch (error: unknown) {
      const errorMessage = error instanceof Error ? error.message : 'Failed to update user';
      alert(errorMessage);
    }
  });

  // Initial load
  loadUsers();
</script>

<style>
  .admin-page {
    min-height: calc(100vh - 200px);
    padding: 2rem 1rem;
  }

  .admin-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .back-btn {
    color: rgb(var(--text-secondary));
    text-decoration: none;
    font-size: 0.9rem;
  }

  .back-btn:hover {
    color: rgb(var(--accent));
  }

  .page-header h1 {
    font-size: 1.5rem;
    margin: 0;
    color: rgb(var(--text-primary));
  }

  .header-actions {
    display: flex;
    gap: 0.75rem;
  }

  .search-input,
  .filter-select {
    padding: 0.5rem 1rem;
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-sm);
    background: rgb(var(--bg-primary));
    color: rgb(var(--text-primary));
    font-size: 0.9rem;
  }

  .search-input {
    width: 200px;
  }

  .table-container {
    background: rgb(var(--bg-primary));
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
  }

  .data-table th,
  .data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid rgb(var(--card-border));
  }

  .data-table th {
    font-size: 0.8rem;
    font-weight: 600;
    color: rgb(var(--text-muted));
    text-transform: uppercase;
    background: rgb(var(--bg-secondary));
  }

  .data-table td {
    font-size: 0.9rem;
    color: rgb(var(--text-primary));
  }

  .user-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .user-info span {
    color: rgb(var(--text-muted));
    font-size: 0.85rem;
  }

  .badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: var(--radius-full);
    font-size: 0.7rem;
    font-weight: 600;
    margin-right: 0.25rem;
  }

  .badge-admin { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
  .badge-affiliate { background: rgba(16, 185, 129, 0.1); color: #10b981; }
  .badge-subscribed { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
  .badge-free { background: rgba(var(--text-muted), 0.1); color: rgb(var(--text-muted)); }

  .action-btn {
    padding: 0.4rem 0.75rem;
    background: rgb(var(--accent));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    cursor: pointer;
  }

  .action-btn:hover {
    background: rgb(var(--accent-hover));
  }

  .loading-state,
  .error-state,
  .empty-state {
    text-align: center;
    padding: 2rem !important;
    color: rgb(var(--text-muted));
  }

  .error-state {
    color: rgb(var(--accent));
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 1rem;
  }

  .pagination button {
    padding: 0.5rem 1rem;
    border: 1px solid rgb(var(--card-border));
    background: rgb(var(--bg-primary));
    color: rgb(var(--text-primary));
    border-radius: var(--radius-sm);
    cursor: pointer;
  }

  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    position: relative;
    background: rgb(var(--bg-primary));
    border-radius: var(--radius-lg);
    padding: 2rem;
    width: 100%;
    max-width: 400px;
    margin: 1rem;
  }

  .modal-content h2 {
    margin: 0 0 1.5rem;
    color: rgb(var(--text-primary));
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    font-size: 0.9rem;
    font-weight: 500;
    color: rgb(var(--text-primary));
    margin-bottom: 0.5rem;
  }

  .form-group input[type="text"],
  .form-group input[type="email"] {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-sm);
    background: rgb(var(--bg-primary));
    color: rgb(var(--text-primary));
  }

  .readonly-input {
    background: rgb(var(--bg-secondary)) !important;
    color: rgb(var(--text-muted)) !important;
  }

  .form-group small {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.8rem;
    color: rgb(var(--text-muted));
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
  }

  .modal-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  .btn-secondary,
  .btn-primary {
    flex: 1;
    padding: 0.75rem;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 500;
    cursor: pointer;
  }

  .btn-secondary {
    background: rgb(var(--bg-secondary));
    color: rgb(var(--text-primary));
    border: 1px solid rgb(var(--card-border));
  }

  .btn-primary {
    background: rgb(var(--accent));
    color: white;
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .header-actions {
      width: 100%;
    }

    .search-input {
      flex: 1;
    }

    .table-container {
      overflow-x: auto;
    }
  }
</style>
