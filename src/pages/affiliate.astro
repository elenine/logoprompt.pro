---
import Layout from '../layouts/Layout.astro';

export const prerender = false;

const user = Astro.locals.user;

// This page is protected by middleware
if (!user) {
  return Astro.redirect('/login');
}
---

<Layout title="Affiliate Dashboard - LogoPrompt.pro" description="Your affiliate dashboard">
  <main class="affiliate-page">
    <div class="affiliate-container">
      <!-- Loading State -->
      <div id="loading-state" class="loading-card">
        <div class="spinner"></div>
        <p>Loading dashboard...</p>
      </div>

      <!-- Error State (not an affiliate) -->
      <div id="error-state" class="error-card" style="display: none;">
        <h1>Access Denied</h1>
        <p>You are not registered as an affiliate.</p>
        <p class="subtext">If you believe this is an error, please contact support.</p>
        <a href="/profile" class="back-btn">Back to Profile</a>
      </div>

      <!-- Dashboard Content -->
      <div id="dashboard-content" style="display: none;">
        <header class="dashboard-header">
          <h1>Affiliate Dashboard</h1>
          <div class="referral-link-box">
            <span class="label">Your Referral Link:</span>
            <div class="link-container">
              <input type="text" id="referral-link" readonly />
              <button id="copy-link-btn" class="copy-btn" type="button">
                <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <svg class="check-icon" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span class="btn-text">Copy</span>
              </button>
            </div>
          </div>
          <!-- Direct Link Verification Status -->
          <div id="direct-link-status" class="direct-link-status" style="display: none;">
            <div id="direct-link-verified" class="status-banner verified" style="display: none;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              <span>Your direct link is verified and active</span>
            </div>
            <div id="direct-link-pending" class="status-banner pending" style="display: none;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span>Your direct link is pending verification by admin</span>
            </div>
            <div id="direct-link-none" class="status-banner none" style="display: none;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <span>No direct link configured. Contact admin to set up your direct link.</span>
            </div>
          </div>
        </header>

        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon subscribers">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-value" id="active-subscribers">0</span>
              <span class="stat-label">Active Subscribers</span>
              <span class="stat-sublabel">$0.50/month each</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon balance">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-value" id="available-balance">$0.00</span>
              <span class="stat-label">Available Balance</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon paid">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-value" id="total-paid">$0.00</span>
              <span class="stat-label">Total Paid Out</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon referrals">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <line x1="19" y1="8" x2="19" y2="14"></line>
                <line x1="22" y1="11" x2="16" y2="11"></line>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-value" id="total-referrals">0</span>
              <span class="stat-label">Total Referrals</span>
            </div>
          </div>
        </div>

        <!-- Payout Settings Section -->
        <div class="payout-settings-section">
          <h2>Payout Settings</h2>
          <p class="section-info">Configure how you want to receive your earnings.</p>

          <form id="payout-settings-form">
            <div class="form-group">
              <label>Payout Method</label>
              <div class="method-selector">
                <label class="method-option">
                  <input type="radio" name="payoutMethod" value="paypal" checked />
                  <span class="method-card">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944 3.72a.77.77 0 0 1 .758-.648h6.89c2.258 0 3.88.66 4.81 1.956.78 1.087.99 2.49.64 4.17-.043.214-.1.455-.17.72-.69 2.69-2.32 4.53-4.85 5.49-.58.22-1.2.38-1.85.49-.48.08-.97.12-1.48.12H7.97a.77.77 0 0 0-.758.65l-1.137 4.67zm2.315-7.67h1.6c1.94 0 3.41-.42 4.4-1.24 1.09-.91 1.7-2.27 1.84-4.07.04-.56.02-1.06-.08-1.49-.21-.93-.73-1.62-1.54-2.08-.68-.38-1.57-.57-2.65-.57H10.46l-1.07 9.45z"/>
                    </svg>
                    <span>PayPal</span>
                    <span class="method-note">International</span>
                  </span>
                </label>
                <label class="method-option">
                  <input type="radio" name="payoutMethod" value="bank_transfer" />
                  <span class="method-card">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                      <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                    <span>Bank Transfer</span>
                    <span class="method-note">Sri Lanka only</span>
                  </span>
                </label>
              </div>
            </div>

            <!-- PayPal Fields -->
            <div id="paypal-fields" class="method-fields">
              <div class="form-group">
                <label for="paypalEmail">PayPal Email</label>
                <input type="email" id="paypalEmail" name="paypalEmail" placeholder="your@email.com" />
              </div>
            </div>

            <!-- Bank Transfer Fields -->
            <div id="bank-fields" class="method-fields" style="display: none;">
              <div class="form-group">
                <label for="country">Country</label>
                <select id="country" name="country">
                  <option value="sri_lanka">Sri Lanka</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="bankName">Bank Name</label>
                <input type="text" id="bankName" name="bankName" placeholder="e.g., Bank of Ceylon" />
              </div>
              <div class="form-group">
                <label for="bankBranch">Branch (Optional)</label>
                <input type="text" id="bankBranch" name="bankBranch" placeholder="e.g., Colombo Fort" />
              </div>
              <div class="form-group">
                <label for="bankAccountNumber">Account Number</label>
                <input type="text" id="bankAccountNumber" name="bankAccountNumber" placeholder="Your account number" />
              </div>
              <div class="form-group">
                <label for="bankAccountName">Account Holder Name</label>
                <input type="text" id="bankAccountName" name="bankAccountName" placeholder="Name on account" />
              </div>
            </div>

            <button type="submit" class="save-settings-btn" id="save-settings-btn">
              <span class="btn-text">Save Settings</span>
            </button>
            <p id="settings-message" class="settings-message" style="display: none;"></p>
          </form>
        </div>

        <!-- Payout Request Section -->
        <div class="payout-section">
          <h2>Request Payout</h2>
          <p class="payout-info">Minimum payout: $5.00. Payouts are processed within 3-5 business days.</p>
          <div class="payout-status" id="payout-status" style="display: none;">
            <span class="status-icon"></span>
            <span class="status-text"></span>
          </div>
          <button id="request-payout-btn" class="payout-btn" type="button" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            <span class="payout-btn-text">Request Payout</span>
          </button>
          <p id="payout-error" class="payout-error" style="display: none;"></p>
        </div>

        <!-- Referrals Table -->
        <div class="referrals-section">
          <h2>Your Referrals</h2>
          <div class="table-container">
            <table class="referrals-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Joined</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="referrals-tbody">
                <tr>
                  <td colspan="4" class="empty-state">No referrals yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="dashboard-footer">
          <a href="/profile" class="back-link">Back to Profile</a>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  interface Referral {
    id: string;
    name: string;
    email: string;
    joinedAt: string;
    isSubscribed: boolean;
    subscriptionStatus: string;
  }

  interface DirectLinkInfo {
    url: string;
    isVerified: boolean;
    isActive: boolean;
  }

  interface ReferralStats {
    referralCode: string;
    totalReferrals: number;
    activeSubscribers: number;
    earningPerSubscriber: number;
    totalEarned: number;
    totalPaidOut: number;
    pendingPayout: number;
    availableBalance: number;
    hasPayoutSettings: boolean;
    referrals: Referral[];
    directLink: DirectLinkInfo | null;
  }

  interface PayoutSettings {
    payoutMethod: 'paypal' | 'bank_transfer';
    country: string;
    paypalEmail: string | null;
    bankName: string | null;
    bankBranch: string | null;
    bankAccountNumber: string | null;
    bankAccountName: string | null;
  }

  let currentBalance = 0;
  let hasPayoutSettings = false;

  function createReferralRow(referral: Referral): HTMLTableRowElement {
    const tr = document.createElement('tr');

    const nameTd = document.createElement('td');
    nameTd.textContent = referral.name;
    tr.appendChild(nameTd);

    const emailTd = document.createElement('td');
    emailTd.textContent = referral.email;
    tr.appendChild(emailTd);

    const joinedTd = document.createElement('td');
    joinedTd.textContent = new Date(referral.joinedAt).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
    tr.appendChild(joinedTd);

    const statusTd = document.createElement('td');
    const badge = document.createElement('span');
    badge.className = `status-badge ${referral.isSubscribed ? 'subscribed' : 'free'}`;
    badge.textContent = referral.isSubscribed ? 'Subscribed' : 'Free';
    statusTd.appendChild(badge);
    tr.appendChild(statusTd);

    return tr;
  }

  function createEmptyRow(): HTMLTableRowElement {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 4;
    td.className = 'empty-state';
    td.textContent = 'No referrals yet';
    tr.appendChild(td);
    return tr;
  }

  function updatePayoutButton() {
    const payoutBtn = document.getElementById('request-payout-btn') as HTMLButtonElement;
    const payoutStatus = document.getElementById('payout-status')!;

    if (currentBalance >= 5 && hasPayoutSettings) {
      payoutBtn.disabled = false;
      payoutStatus.style.display = 'none';
    } else if (currentBalance >= 5 && !hasPayoutSettings) {
      payoutBtn.disabled = true;
      payoutStatus.style.display = 'flex';
      payoutStatus.className = 'payout-status warning';
      const statusText = payoutStatus.querySelector('.status-text');
      if (statusText) {
        statusText.textContent = 'Please configure your payout settings above to request a payout.';
      }
    } else {
      payoutBtn.disabled = true;
      if (currentBalance > 0) {
        payoutStatus.style.display = 'flex';
        payoutStatus.className = 'payout-status info';
        const statusText = payoutStatus.querySelector('.status-text');
        if (statusText) {
          statusText.textContent = `You need $${(5 - currentBalance).toFixed(2)} more to reach the minimum payout.`;
        }
      }
    }
  }

  async function loadDashboard() {
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const dashboardContent = document.getElementById('dashboard-content');

    try {
      const response = await fetch('/api/affiliate/stats');

      if (response.status === 403) {
        loadingState!.style.display = 'none';
        errorState!.style.display = 'block';
        return;
      }

      if (!response.ok) {
        throw new Error('Failed to load stats');
      }

      const stats: ReferralStats = await response.json();
      currentBalance = stats.availableBalance;
      hasPayoutSettings = stats.hasPayoutSettings;

      // Update stats using textContent (safe)
      document.getElementById('active-subscribers')!.textContent = stats.activeSubscribers.toString();
      document.getElementById('available-balance')!.textContent = `$${stats.availableBalance.toFixed(2)}`;
      document.getElementById('total-paid')!.textContent = `$${stats.totalPaidOut.toFixed(2)}`;
      document.getElementById('total-referrals')!.textContent = stats.totalReferrals.toString();

      // Set referral link
      const referralLink = `${window.location.origin}?ref=${stats.referralCode}`;
      (document.getElementById('referral-link') as HTMLInputElement).value = referralLink;

      // Display direct link verification status
      const directLinkStatus = document.getElementById('direct-link-status');
      const directLinkVerified = document.getElementById('direct-link-verified');
      const directLinkPending = document.getElementById('direct-link-pending');
      const directLinkNone = document.getElementById('direct-link-none');

      if (directLinkStatus) {
        directLinkStatus.style.display = 'block';
        if (stats.directLink) {
          if (stats.directLink.isVerified && stats.directLink.isActive) {
            directLinkVerified!.style.display = 'flex';
            directLinkPending!.style.display = 'none';
            directLinkNone!.style.display = 'none';
          } else {
            directLinkVerified!.style.display = 'none';
            directLinkPending!.style.display = 'flex';
            directLinkNone!.style.display = 'none';
          }
        } else {
          directLinkVerified!.style.display = 'none';
          directLinkPending!.style.display = 'none';
          directLinkNone!.style.display = 'flex';
        }
      }

      // Update payout button state
      updatePayoutButton();

      // Populate referrals table using safe DOM methods
      const tbody = document.getElementById('referrals-tbody')!;
      tbody.replaceChildren(); // Clear existing rows

      if (stats.referrals.length === 0) {
        tbody.appendChild(createEmptyRow());
      } else {
        stats.referrals.forEach(referral => {
          tbody.appendChild(createReferralRow(referral));
        });
      }

      loadingState!.style.display = 'none';
      dashboardContent!.style.display = 'block';

      // Load payout settings
      loadPayoutSettings();
    } catch (error) {
      console.error('Dashboard error:', error);
      const loadingP = loadingState?.querySelector('p');
      if (loadingP) {
        loadingP.textContent = 'Failed to load dashboard. Please refresh.';
        loadingP.className = 'error-text';
      }
    }
  }

  async function loadPayoutSettings() {
    try {
      const response = await fetch('/api/affiliate/settings');
      if (!response.ok) return;

      const { settings }: { settings: PayoutSettings } = await response.json();

      // Set method
      const methodRadio = document.querySelector(`input[name="payoutMethod"][value="${settings.payoutMethod}"]`) as HTMLInputElement;
      if (methodRadio) {
        methodRadio.checked = true;
        toggleMethodFields(settings.payoutMethod);
      }

      // Fill in fields
      if (settings.paypalEmail) {
        (document.getElementById('paypalEmail') as HTMLInputElement).value = settings.paypalEmail;
      }
      if (settings.country) {
        (document.getElementById('country') as HTMLSelectElement).value = settings.country;
      }
      if (settings.bankName) {
        (document.getElementById('bankName') as HTMLInputElement).value = settings.bankName;
      }
      if (settings.bankBranch) {
        (document.getElementById('bankBranch') as HTMLInputElement).value = settings.bankBranch;
      }
      if (settings.bankAccountNumber) {
        (document.getElementById('bankAccountNumber') as HTMLInputElement).value = settings.bankAccountNumber;
      }
      if (settings.bankAccountName) {
        (document.getElementById('bankAccountName') as HTMLInputElement).value = settings.bankAccountName;
      }
    } catch (error) {
      console.error('Failed to load payout settings:', error);
    }
  }

  function toggleMethodFields(method: string) {
    const paypalFields = document.getElementById('paypal-fields')!;
    const bankFields = document.getElementById('bank-fields')!;

    if (method === 'paypal') {
      paypalFields.style.display = 'block';
      bankFields.style.display = 'none';
    } else {
      paypalFields.style.display = 'none';
      bankFields.style.display = 'block';
    }
  }

  // Method selector change
  document.querySelectorAll('input[name="payoutMethod"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      toggleMethodFields(target.value);
    });
  });

  // Save payout settings
  document.getElementById('payout-settings-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const btn = document.getElementById('save-settings-btn') as HTMLButtonElement;
    const btnText = btn.querySelector('.btn-text')!;
    const messageEl = document.getElementById('settings-message')!;

    btn.disabled = true;
    btnText.textContent = 'Saving...';
    messageEl.style.display = 'none';

    const payoutMethod = (document.querySelector('input[name="payoutMethod"]:checked') as HTMLInputElement).value;

    const data: Record<string, string> = {
      payoutMethod,
      country: (document.getElementById('country') as HTMLSelectElement).value,
    };

    if (payoutMethod === 'paypal') {
      data.paypalEmail = (document.getElementById('paypalEmail') as HTMLInputElement).value;
    } else {
      data.bankName = (document.getElementById('bankName') as HTMLInputElement).value;
      data.bankBranch = (document.getElementById('bankBranch') as HTMLInputElement).value;
      data.bankAccountNumber = (document.getElementById('bankAccountNumber') as HTMLInputElement).value;
      data.bankAccountName = (document.getElementById('bankAccountName') as HTMLInputElement).value;
    }

    try {
      const response = await fetch('/api/affiliate/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Failed to save settings');
      }

      messageEl.textContent = 'Settings saved successfully!';
      messageEl.className = 'settings-message success';
      messageEl.style.display = 'block';

      hasPayoutSettings = true;
      updatePayoutButton();

      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 3000);
    } catch (error: unknown) {
      const errorMessage = error instanceof Error ? error.message : 'An error occurred';
      messageEl.textContent = errorMessage;
      messageEl.className = 'settings-message error';
      messageEl.style.display = 'block';
    } finally {
      btn.disabled = false;
      btnText.textContent = 'Save Settings';
    }
  });

  // Copy referral link
  document.getElementById('copy-link-btn')?.addEventListener('click', async () => {
    const input = document.getElementById('referral-link') as HTMLInputElement;
    const btn = document.getElementById('copy-link-btn') as HTMLButtonElement;
    const copyIcon = btn.querySelector('.copy-icon') as SVGElement;
    const checkIcon = btn.querySelector('.check-icon') as SVGElement;
    const btnText = btn.querySelector('.btn-text') as HTMLSpanElement;

    try {
      await navigator.clipboard.writeText(input.value);

      copyIcon.style.display = 'none';
      checkIcon.style.display = 'inline';
      btnText.textContent = 'Copied!';
      btn.classList.add('copied');

      setTimeout(() => {
        copyIcon.style.display = 'inline';
        checkIcon.style.display = 'none';
        btnText.textContent = 'Copy';
        btn.classList.remove('copied');
      }, 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  });

  // Request payout
  document.getElementById('request-payout-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('request-payout-btn') as HTMLButtonElement;
    const btnText = btn.querySelector('.payout-btn-text') as HTMLSpanElement;
    const errorEl = document.getElementById('payout-error')!;

    btn.disabled = true;
    btnText.textContent = 'Processing...';
    errorEl.style.display = 'none';

    try {
      const response = await fetch('/api/affiliate/request-payout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Failed to request payout');
      }

      // Show success and reload
      const payoutStatus = document.getElementById('payout-status')!;
      payoutStatus.style.display = 'flex';
      payoutStatus.className = 'payout-status success';
      const statusText = payoutStatus.querySelector('.status-text');
      if (statusText) {
        statusText.textContent = `Payout request for $${result.amount.toFixed(2)} submitted successfully!`;
      }

      // Reload dashboard after a short delay
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } catch (error: unknown) {
      const errorMessage = error instanceof Error ? error.message : 'An error occurred';
      errorEl.textContent = errorMessage;
      errorEl.style.display = 'block';
      btn.disabled = false;
      btnText.textContent = 'Request Payout';
    }
  });

  // Load dashboard on page load
  loadDashboard();
</script>

<style>
  .affiliate-page {
    min-height: calc(100vh - 200px);
    padding: 2rem 1rem;
  }

  .affiliate-container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .loading-card,
  .error-card {
    background: rgb(var(--bg-primary));
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-lg);
    padding: 3rem;
    text-align: center;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgb(var(--card-border));
    border-top-color: rgb(var(--accent));
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .error-card h1 {
    color: rgb(var(--accent));
    margin: 0 0 0.5rem;
  }

  .error-card .subtext {
    color: rgb(var(--text-muted));
    font-size: 0.9rem;
  }

  .back-btn {
    display: inline-block;
    margin-top: 1.5rem;
    padding: 0.75rem 1.5rem;
    background: rgb(var(--accent));
    color: white;
    border-radius: var(--radius-md);
    text-decoration: none;
    font-weight: 500;
  }

  .dashboard-header {
    margin-bottom: 2rem;
  }

  .dashboard-header h1 {
    font-size: 1.75rem;
    margin: 0 0 1rem;
    color: rgb(var(--text-primary));
  }

  .referral-link-box {
    background: rgb(var(--bg-secondary));
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-md);
    padding: 1rem;
  }

  .referral-link-box .label {
    display: block;
    font-size: 0.85rem;
    color: rgb(var(--text-muted));
    margin-bottom: 0.5rem;
  }

  .link-container {
    display: flex;
    gap: 0.5rem;
  }

  .link-container input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-sm);
    background: rgb(var(--bg-primary));
    color: rgb(var(--text-primary));
    font-size: 0.9rem;
  }

  .copy-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: rgb(var(--accent));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 500;
    cursor: pointer;
    transition: background var(--transition-fast);
  }

  .copy-btn:hover {
    background: rgb(var(--accent-hover));
  }

  .copy-btn.copied {
    background: #16a34a;
  }

  /* Direct Link Status */
  .direct-link-status {
    margin-top: 1rem;
  }

  .status-banner {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    font-weight: 500;
  }

  .status-banner.verified {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.3);
  }

  .status-banner.pending {
    background: rgba(255, 193, 7, 0.1);
    color: #e0a800;
    border: 1px solid rgba(255, 193, 7, 0.3);
  }

  .status-banner.none {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
    border: 1px solid rgba(108, 117, 125, 0.3);
  }

  .status-banner svg {
    flex-shrink: 0;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: rgb(var(--bg-primary));
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .stat-icon.subscribers { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
  .stat-icon.balance { background: rgba(16, 185, 129, 0.1); color: #10b981; }
  .stat-icon.paid { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
  .stat-icon.referrals { background: rgba(249, 115, 22, 0.1); color: #f97316; }

  .stat-content {
    display: flex;
    flex-direction: column;
  }

  .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: rgb(var(--text-primary));
    line-height: 1;
  }

  .stat-label {
    font-size: 0.9rem;
    color: rgb(var(--text-secondary));
    margin-top: 0.25rem;
  }

  .stat-sublabel {
    font-size: 0.75rem;
    color: rgb(var(--text-muted));
  }

  /* Payout Settings Section */
  .payout-settings-section {
    background: rgb(var(--bg-primary));
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .payout-settings-section h2 {
    font-size: 1.1rem;
    margin: 0 0 0.5rem;
    color: rgb(var(--text-primary));
  }

  .section-info {
    font-size: 0.9rem;
    color: rgb(var(--text-secondary));
    margin: 0 0 1.5rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    font-size: 0.85rem;
    font-weight: 500;
    color: rgb(var(--text-primary));
    margin-bottom: 0.5rem;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-sm);
    background: rgb(var(--bg-secondary));
    color: rgb(var(--text-primary));
    font-size: 0.9rem;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: rgb(var(--accent));
  }

  .method-selector {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .method-option input {
    display: none;
  }

  .method-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1.25rem;
    border: 2px solid rgb(var(--card-border));
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .method-card:hover {
    border-color: rgb(var(--text-muted));
  }

  .method-option input:checked + .method-card {
    border-color: rgb(var(--accent));
    background: rgba(var(--accent), 0.05);
  }

  .method-card svg {
    color: rgb(var(--text-muted));
  }

  .method-option input:checked + .method-card svg {
    color: rgb(var(--accent));
  }

  .method-card span {
    font-size: 0.9rem;
    font-weight: 500;
    color: rgb(var(--text-primary));
  }

  .method-note {
    font-size: 0.75rem !important;
    font-weight: 400 !important;
    color: rgb(var(--text-muted)) !important;
  }

  .method-fields {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgb(var(--card-border));
  }

  .save-settings-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: rgb(var(--accent));
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    cursor: pointer;
    transition: background var(--transition-fast);
  }

  .save-settings-btn:hover:not(:disabled) {
    background: rgb(var(--accent-hover));
  }

  .save-settings-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .settings-message {
    margin-top: 0.75rem;
    font-size: 0.9rem;
  }

  .settings-message.success {
    color: #16a34a;
  }

  .settings-message.error {
    color: rgb(var(--accent));
  }

  .payout-section {
    background: rgb(var(--bg-primary));
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .payout-section h2 {
    font-size: 1.1rem;
    margin: 0 0 0.5rem;
    color: rgb(var(--text-primary));
  }

  .payout-info {
    font-size: 0.9rem;
    color: rgb(var(--text-secondary));
    margin: 0 0 1rem;
  }

  .payout-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-sm);
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }

  .payout-status.info {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
  }

  .payout-status.warning {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
  }

  .payout-status.success {
    background: rgba(16, 185, 129, 0.1);
    color: #16a34a;
  }

  .payout-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    width: 100%;
    max-width: 320px;
    padding: 0.875rem 1.5rem;
    background: rgb(var(--accent));
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background var(--transition-fast);
  }

  .payout-btn:hover:not(:disabled) {
    background: rgb(var(--accent-hover));
  }

  .payout-btn:disabled {
    background: rgb(var(--text-muted));
    cursor: not-allowed;
  }

  .payout-error {
    color: rgb(var(--accent));
    font-size: 0.9rem;
    margin-top: 0.75rem;
  }

  .referrals-section {
    background: rgb(var(--bg-primary));
    border: 1px solid rgb(var(--card-border));
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .referrals-section h2 {
    font-size: 1.1rem;
    margin: 0 0 1rem;
    color: rgb(var(--text-primary));
  }

  .table-container {
    overflow-x: auto;
  }

  .referrals-table {
    width: 100%;
    border-collapse: collapse;
  }

  .referrals-table th,
  .referrals-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid rgb(var(--card-border));
  }

  .referrals-table th {
    font-size: 0.8rem;
    font-weight: 600;
    color: rgb(var(--text-muted));
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .referrals-table td {
    font-size: 0.9rem;
    color: rgb(var(--text-primary));
  }

  .empty-state {
    text-align: center;
    color: rgb(var(--text-muted));
    padding: 2rem !important;
  }

  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
  }

  .status-badge.subscribed {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
  }

  .status-badge.free {
    background: rgba(var(--text-muted), 0.1);
    color: rgb(var(--text-muted));
  }

  .dashboard-footer {
    text-align: center;
  }

  .back-link {
    color: rgb(var(--accent));
    text-decoration: none;
    font-size: 0.9rem;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  .error-text {
    color: rgb(var(--accent));
  }

  @media (max-width: 640px) {
    .stats-grid {
      grid-template-columns: 1fr 1fr;
    }

    .stat-card {
      flex-direction: column;
      text-align: center;
    }

    .link-container {
      flex-direction: column;
    }

    .method-selector {
      grid-template-columns: 1fr;
    }
  }
</style>
